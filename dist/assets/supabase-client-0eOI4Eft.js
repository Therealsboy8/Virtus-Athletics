import{createClient as r}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";class i{constructor(){this.supabase=null,this.currentUser=null,this.participant=null,this.initialized=!1,this.initialize()}initialize(){const t="https://dfyolvdpzomufcvqxufd.supabase.co",e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmeW9sdmRwem9tdWZjdnF4dWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTk1ODYsImV4cCI6MjA3NzkzNTU4Nn0._swW6Z0-Wqi9VlcCvfSFAu6E-SvSyLkxSAHeaDXELxI";this.supabase=r(t,e,{auth:{persistSession:!0,autoRefreshToken:!0}}),this.setupAuthListener(),this.checkUser()}setupAuthListener(){this.supabase&&this.supabase.auth.onAuthStateChange((t,e)=>{t==="SIGNED_IN"?(this.currentUser=(e==null?void 0:e.user)||null,this.loadParticipantData(),this.updateAuthUI()):t==="SIGNED_OUT"&&(this.currentUser=null,this.participant=null,this.updateAuthUI())})}async checkUser(){if(!this.supabase){this.initialized=!0,this.updateAuthUI();return}try{const{data:{session:t},error:e}=await this.supabase.auth.getSession();t&&t.user&&(this.currentUser=t.user,await this.loadParticipantData())}catch(t){console.error("Error checking user session:",t)}this.initialized=!0,this.updateAuthUI()}async signUp(t,e){if(!this.supabase)return{error:"Supabase not initialized"};const{data:s,error:a}=await this.supabase.auth.signUp({email:t,password:e});return!a&&s.user&&(this.currentUser=s.user),{data:s,error:a}}async signIn(t,e){if(!this.supabase)return{error:"Supabase not initialized"};const{data:s,error:a}=await this.supabase.auth.signInWithPassword({email:t,password:e});return!a&&s.user&&(this.currentUser=s.user,await this.loadParticipantData()),{data:s,error:a}}async signOut(){this.supabase&&(await this.supabase.auth.signOut(),this.currentUser=null,this.participant=null,this.updateAuthUI())}async loadParticipantData(){if(!this.supabase||!this.currentUser)return;const{data:t,error:e}=await this.supabase.from("challenge_participants").select("*").eq("user_id",this.currentUser.id).maybeSingle();t&&(this.participant=t),this.updateAuthUI()}async joinChallenge(){if(!this.supabase||!this.currentUser)return{error:"Must be logged in to join challenge"};if(this.participant)return{error:"Already joined challenge"};const{data:t,error:e}=await this.supabase.from("challenge_participants").insert([{user_id:this.currentUser.id,email:this.currentUser.email,started_at:new Date().toISOString(),current_day:1,completed:!1}]).select().single();return e||(this.participant=t,await this.initializeProgress()),{data:t,error:e}}async initializeProgress(){if(!this.supabase||!this.participant)return;const t=Array.from({length:30},(e,s)=>({participant_id:this.participant.id,day_number:s+1,completed:!1}));await this.supabase.from("challenge_progress").insert(t)}async getProgress(){if(!this.supabase||!this.participant)return[];const{data:t,error:e}=await this.supabase.from("challenge_progress").select("*").eq("participant_id",this.participant.id).order("day_number");return t||[]}async completeDay(t,e=""){if(!this.supabase||!this.participant)return{error:"Not authorized"};const{data:s,error:a}=await this.supabase.from("challenge_progress").update({completed:!0,completed_at:new Date().toISOString(),notes:e}).eq("participant_id",this.participant.id).eq("day_number",t).select().single();return a||await this.updateCurrentDay(),{data:s,error:a}}async updateCurrentDay(){if(!this.supabase||!this.participant)return;const e=(await this.getProgress()).filter(a=>a.completed).length,s=Math.min(e+1,30);await this.supabase.from("challenge_participants").update({current_day:s,completed:e===30}).eq("id",this.participant.id),this.participant.current_day=s,this.participant.completed=e===30}async getWorkouts(){if(!this.supabase)return[];const{data:t,error:e}=await this.supabase.from("challenge_workouts").select("*").order("day_number");return t||[]}async getWorkout(t){if(!this.supabase)return null;const{data:e,error:s}=await this.supabase.from("challenge_workouts").select("*").eq("day_number",t).maybeSingle();return e}updateAuthUI(){const t=document.querySelectorAll(".auth-required"),e=document.querySelectorAll(".guest-only"),s=document.querySelectorAll(".user-info");this.currentUser?(t.forEach(a=>a.style.display="block"),e.forEach(a=>a.style.display="none"),s.forEach(a=>{a.textContent=this.currentUser.email,a.style.display="block"})):(t.forEach(a=>a.style.display="none"),e.forEach(a=>a.style.display="block"),s.forEach(a=>a.style.display="none"))}isAuthenticated(){return!!this.currentUser}hasJoinedChallenge(){return!!this.participant}}window.supabaseService=new i;
